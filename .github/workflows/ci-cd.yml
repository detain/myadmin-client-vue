---
name: CI/CD - Web + Electron

on:
    push:
        branches:
            - master
            - electron
        tags:
            - 'v*'
    pull_request:
        branches:
            - master
            - electron

jobs:
    # ---------------- WEB BUILD ON MASTER ----------------
    web-build:
        if: github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/')
        runs-on: ubuntu-latest

        steps:
            - name: checkout repo
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0 # fetch full history

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 22
                  cache: yarn

            - run: yarn
            - run: yarn build

            - name: Read version
              run: echo "APP_VERSION=$(node -p "require('./package.json').version")" >> $GITHUB_ENV

            - name: Zip dist for dev
              run: zip -r my-interserver-client-web-dev-master.zip dist

            - name: Upload dev artifact
              uses: actions/upload-artifact@v4
              with:
                  name: web-dev-master
                  path: my-interserver-client-web-dev-master.zip

            - name: Publish release zip (if tag)
              if: startsWith(github.ref, 'refs/tags/')
              run: |
                  VERSION=$(node -p "require('./package.json').version")
                  zip -r my-interserver-client-web-${VERSION}.zip dist
                  gh release upload ${GITHUB_REF_NAME} my-interserver-client-web-${VERSION}.zip --clobber

    # ---------------- ELECTRON BUILD ON ELECTRON BRANCH ----------------
    electron-build:
        if: github.ref == 'refs/heads/electron' || startsWith(github.ref, 'refs/tags/')
        runs-on: ${{ matrix.os }}

        strategy:
            fail-fast: false
            matrix:
                include:
                    # Linux
                    - os: ubuntu-latest
                      platform: linux
                      arch: x64
                      build_args: --linux AppImage snap deb --x64
                    - os: ubuntu-latest
                      platform: linux
                      arch: arm64
                      build_args: --linux AppImage deb --arm64

                    # Windows
                    - os: windows-latest
                      platform: win
                      arch: x64
                      build_args: --win nsis portable --x64
                    - os: windows-latest
                      platform: win
                      arch: arm64
                      build_args: --win nsis portable --arm64

                    # macOS
                    - os: macos-latest
                      platform: mac
                      arch: universal
                      build_args: --mac dmg pkg

        env:
            ELECTRON_CACHE: ~/.cache/electron
            ELECTRON_BUILDER_CACHE: ~/.cache/electron-builder

            # Signing / notarization (only needed for tagged builds)
            CSC_LINK: ${{ secrets.CSC_LINK }}
            CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}
            WIN_CSC_LINK: ${{ secrets.WIN_CSC_LINK }}
            WIN_CSC_KEY_PASSWORD: ${{ secrets.WIN_CSC_KEY_PASSWORD }}
            APPLE_ID: ${{ secrets.APPLE_ID }}
            APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
            APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

        steps:
            - uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 22
                  cache: yarn

            - run: corepack enable

            - name: Restore Electron cache
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cache/electron
                      ~/.cache/electron-builder
                  key: electron-${{ runner.os }}-${{ hashFiles('yarn.lock') }}

            - name: Install dependencies
              run: yarn --frozen-lockfile

            - name: Read app version
              run: echo "APP_VERSION=$(node -p "require('./package.json').version")" >> $GITHUB_ENV

            - name: Install Linux dependencies
              if: matrix.platform == 'linux'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y libarchive-tools rpm
                  sudo snap install snapcraft --classic

            # Disable code signing for PRs and CI Mac builds
            - name: Disable signing for PRs / CI Mac
              if: github.event_name == 'pull_request' || matrix.platform == 'mac'
              run: echo "CSC_IDENTITY_AUTO_DISCOVERY=false" >> $GITHUB_ENV

            - name: Build Web / Site
              run: yarn build

            # Build Electron
            - name: Build Electron app
              run: npx electron-builder ${{ matrix.build_args }}
              env:
                  CSC_IDENTITY_AUTO_DISCOVERY: ${{ env.CSC_IDENTITY_AUTO_DISCOVERY || 'true' }}

            # ---------------- ZIP UNPACKED ----------------
            - name: Zip unpacked (Linux)
              if: matrix.platform == 'linux'
              run: |
                  cd dist
                  if [ "${{ matrix.arch }}" = "arm64" ]; then
                    zip -r my-interserver-client-${APP_VERSION}-linux-${{ matrix.arch }}.zip linux-arm64-unpacked
                  else
                    zip -r my-interserver-client-${APP_VERSION}-linux-${{ matrix.arch }}.zip linux-unpacked
                  fi

            - name: Zip unpacked (Windows)
              if: matrix.platform == 'win'
              shell: pwsh
              run: |
                  cd dist
                  if ("${{ matrix.arch }}" -eq "arm64") {
                    $src = "win-arm64-unpacked"
                  } else {
                    $src = "win-unpacked"
                  }
                  $zip = "my-interserver-client-$env:APP_VERSION-windows-${{ matrix.arch }}.zip"
                  Compress-Archive -Path $src -DestinationPath $zip

            - name: Zip unpacked (macOS)
              if: matrix.platform == 'mac'
              run: |
                  cd dist
                  zip -r my-interserver-client-${APP_VERSION}-mac.zip mac-unpacked

            - name: Upload DEB packages
              uses: actions/upload-artifact@v4
              with:
                  name: deb-${{ matrix.platform }}-${{ matrix.arch }}
                  path: dist/*.deb
                  if-no-files-found: ignore

            - name: Upload AppImage packages
              uses: actions/upload-artifact@v4
              with:
                  name: appimage-${{ matrix.platform }}-${{ matrix.arch }}
                  path: dist/*.AppImage
                  if-no-files-found: ignore

            - name: Upload Snap packages
              uses: actions/upload-artifact@v4
              with:
                  name: snap-${{ matrix.platform }}-${{ matrix.arch }}
                  path: dist/*.snap
                  if-no-files-found: ignore

            - name: Upload Windows installers
              if: matrix.platform == 'win'
              uses: actions/upload-artifact@v4
              with:
                  name: windows-installers-${{ matrix.arch }}
                  path: dist/*setup*.exe
                  if-no-files-found: ignore

            - name: Upload Windows portable builds
              if: matrix.platform == 'win'
              uses: actions/upload-artifact@v4
              with:
                  name: windows-portable-${{ matrix.arch }}
                  path: dist/*portable*.exe
                  if-no-files-found: ignore

            - name: Upload macOS Dmg images
              if: matrix.platform == 'mac'
              uses: actions/upload-artifact@v4
              with:
                  name: macos-${{ matrix.arch }}
                  path: dist/*.dmg
                  if-no-files-found: ignore

            - name: Upload macOS Pkg images
              if: matrix.platform == 'mac'
              uses: actions/upload-artifact@v4
              with:
                  name: macos-${{ matrix.arch }}
                  path: dist/*.pkg
                  if-no-files-found: ignore

            - name: Upload unpacked zips
              uses: actions/upload-artifact@v4
              with:
                  name: unpacked-${{ matrix.platform }}-${{ matrix.arch }}
                  path: dist/*.zip
                  if-no-files-found: ignore

            # ---------------- RELEASE ASSETS ----------------
            - name: Publish release assets (tags)
              if: startsWith(github.ref, 'refs/tags/')
              run: |
                  gh release upload ${GITHUB_REF_NAME} dist/* --clobber

            # ---------------- UPDATE README WITH DOWNLOAD LINKS ----------------
            - name: Update README with latest download links
              if: startsWith(github.ref, 'refs/tags/')
              run: |
                  VERSION="${GITHUB_REF_NAME#v}"
                  REPO_URL="https://github.com/${GITHUB_REPOSITORY}/releases/download/${GITHUB_REF_NAME}"
                  
                  WEB_URL="${REPO_URL}/my-interserver-client-web-${VERSION}.zip"
                  LINUX_URL_X64="${REPO_URL}/my-interserver-client-${VERSION}-linux-x64.zip"
                  LINUX_URL_ARM64="${REPO_URL}/my-interserver-client-${VERSION}-linux-arm64.zip"
                  WIN_URL_X64="${REPO_URL}/my-interserver-client-${VERSION}-windows-x64.zip"
                  WIN_URL_ARM64="${REPO_URL}/my-interserver-client-${VERSION}-windows-arm64.zip"
                  MAC_URL="${REPO_URL}/my-interserver-client-${VERSION}-mac.zip"
                  
                  echo -e "<!-- DOWNLOADS-START -->\n## Latest Downloads (v${VERSION})\n\n### Web\n- [Web (zip)](${WEB_URL})\n\n### Electron\n#### Linux\n- [x64](${LINUX_URL_X64})\n- [arm64](${LINUX_URL_ARM64})\n#### Windows\n- [x64](${WIN_URL_X64})\n- [arm64](${WIN_URL_ARM64})\n#### macOS\n- [Universal](${MAC_URL})\n<!-- DOWNLOADS-END -->" > latest-downloads.md
                  
                  awk '
                    BEGIN {in_block=0}
                    /<!-- DOWNLOADS-START -->/ {
                      system("cat latest-downloads.md")
                      in_block=1
                      next
                    }
                    /<!-- DOWNLOADS-END -->/ {
                      in_block=0
                      next
                    }
                    !in_block {print}
                  ' README.md > README.tmp && mv README.tmp README.md
                  
                  git config user.name "github-actions"
                  git config user.email "github-actions@github.com"
                  git add README.md
                  git commit -m "Update latest download links for v${VERSION}" || echo "No changes to commit"
                  git push
