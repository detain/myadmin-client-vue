---
name: Playwright Tests

on:
    push:
        branches: [main, master]
    pull_request:
        branches: [main, master]
    workflow_dispatch:

concurrency:
    group: ci-${{ github.event.pull_request.number || github.ref }}
    cancel-in-progress: true

env:
    # Explicit browser cache location so we can cache it
    PLAYWRIGHT_BROWSERS_PATH: ${{ github.workspace }}/.cache/ms-playwright

jobs:
    test:
        runs-on: ${{ matrix.os }}
        timeout-minutes: 60

        strategy:
            fail-fast: false
            matrix:
                include:
                    - os: ubuntu-latest
                      node_version: 22
                    #- os: macos-latest
                    #  node_version: 22
                    #- os: windows-latest
                    #  node_version: 22

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ matrix.node_version }}

            - name: Enable Corepack and Yarn 4.12.0
              run: |
                  corepack enable
                  corepack prepare yarn@4.12.0 --activate

            - name: Install dependencies
              run: yarn --frozen-lockfile

            # Cache Playwright browsers (major speed improvement)
            - name: Cache Playwright browsers
              uses: actions/cache@v4
              with:
                  path: ${{ env.PLAYWRIGHT_BROWSERS_PATH }}
                  key: playwright-${{ runner.os }}-${{ hashFiles('yarn.lock') }}
                  restore-keys: |
                      playwright-${{ runner.os }}-

            # Single, correct installation step
            - name: Install Playwright browsers
              run: yarn playwright install --with-deps

            # Vite dev server is started automatically by Playwright
            - name: Run Playwright tests
              run: yarn playwright test
